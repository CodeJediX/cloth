<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clean Boutique | Local Marketplace</title>
    <meta name="description" content="A mobile-first marketplace for local clothing sellers.">

    <style>
        /* =========================================
           CSS VARIABLES & RESET
           ========================================= */
        :root {
            /* Theme Colors */
            --bg: #F7F7F8;
            --card: #FFFFFF;
            --primary: #FF6F61;
            --primary-dark: #e85d50;
            --secondary: #2F3A4A;
            --accent: #FFB85C;
            --muted: #9CA3AF;
            --text: #1F2937;
            --text-light: #6B7280;
            --success: #16A34A;
            --danger: #DC2626;
            --border: #E5E7EB;

            /* Spacing & Layout */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.08);
            --header-height: 60px;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            font-size: 16px;
            line-height: 1.5;
            padding-bottom: 80px; /* Space for bottom elements */
        }

        /* Typography */
        h1, h2, h3, h4 { margin: 0; font-weight: 700; color: var(--secondary); }
        h1 { font-size: 1.75rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.1rem; }
        small { font-size: 0.85rem; color: var(--text-light); }
        a { text-decoration: none; color: inherit; cursor: pointer; }

        /* Utilities */
        .container { max-width: 600px; margin: 0 auto; padding: 0 16px; } /* Mobile-focused width */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .align-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .font-bold { font-weight: 700; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-4 { margin-bottom: 16px; }

        /* =========================================
           COMPONENTS
           ========================================= */
        
        /* Header */
        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-height);
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 1px 0 var(--border);
            z-index: 100;
        }
        .brand { font-size: 1.2rem; font-weight: 800; color: var(--secondary); letter-spacing: -0.5px; }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; position: relative; color: var(--secondary); }
        .badge {
            position: absolute; top: -2px; right: -2px;
            background: var(--primary); color: white;
            font-size: 10px; font-weight: bold;
            height: 16px; min-width: 16px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            padding: 0 4px;
        }

        /* Navigation Drawer (Simple overlay for MVP) */
        #nav-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200; display: none;
        }
        #nav-menu {
            position: absolute; top: 0; left: 0; width: 280px; height: 100%;
            background: var(--card); padding: 24px;
            transform: translateX(-100%); transition: transform 0.3s ease;
        }
        #nav-menu.open { transform: translateX(0); }
        .nav-link { display: block; padding: 12px 0; font-size: 1.1rem; border-bottom: 1px solid var(--bg); }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 24px; border-radius: 30px;
            font-weight: 600; border: none; cursor: pointer;
            transition: opacity 0.2s; width: 100%;
            font-size: 1rem;
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 111, 97, 0.3); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }
        .btn-circle { width: 40px; height: 40px; padding: 0; border-radius: 50%; }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            overflow: hidden;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .card-clean { padding: 0; } /* For image-heavy cards */

        /* Inputs */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg);
            font-family: inherit; font-size: 1rem;
        }
        .form-input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 16px;
        }
        .product-card {
            background: var(--card);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
            position: relative;
        }
        .product-img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            background: #e0e0e0;
        }
        .product-info { padding: 12px; }
        .product-title { font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
        .product-seller { font-size: 0.75rem; color: var(--text-light); display: flex; align-items: center; gap: 4px; }
        .verified-badge { color: var(--primary); font-size: 0.8rem; }
        .product-price { margin-top: 4px; font-weight: 700; color: var(--secondary); }
        .discount { text-decoration: line-through; color: var(--muted); font-size: 0.8em; margin-left: 4px; }

        /* Chips / Categories */
        .chip-scroll {
            display: flex; gap: 12px; overflow-x: auto; padding: 16px;
            scrollbar-width: none;
        }
        .chip-scroll::-webkit-scrollbar { display: none; }
        .chip {
            padding: 8px 16px; background: var(--card);
            border-radius: 20px; font-size: 0.9rem; white-space: nowrap;
            border: 1px solid var(--border);
            font-weight: 500;
        }
        .chip.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        /* Image Upload Preview */
        .img-preview {
            width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border);
        }

        /* Toast */
        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(47, 58, 74, 0.95); color: white;
            padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 1000;
            white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #toast.show { opacity: 1; }

        /* Dev Tools */
        #dev-fab {
            position: fixed; bottom: 90px; right: 16px;
            width: 40px; height: 40px; background: var(--text); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; z-index: 90; cursor: pointer; opacity: 0.5;
        }
        #dev-fab:hover { opacity: 1; }
        .dev-panel { 
            position: fixed; bottom: 140px; right: 16px; width: 200px;
            background: var(--card); padding: 12px; border-radius: 8px;
            box-shadow: var(--shadow-lg); z-index: 91; display: none; border: 1px solid var(--border);
        }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Stat Card */
        .stat-card { text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px; }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--secondary); }
        .stat-label { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body>

    <header>
        <button class="icon-btn" onclick="UI.toggleMenu()">â˜°</button>
        <div class="brand" onclick="Router.go('/')">Clean Boutique</div>
        <button class="icon-btn" onclick="Router.go('/cart')">
            ðŸ›’ <div id="cart-count" class="badge hidden">0</div>
        </button>
    </header>

    <div id="nav-overlay" onclick="UI.toggleMenu()">
        <div id="nav-menu" onclick="event.stopPropagation()">
            <h2 class="mb-4">Menu</h2>
            <a class="nav-link" onclick="UI.navTo('/');">Home</a>
            <a class="nav-link" onclick="UI.navTo('/cart');">My Cart</a>
            <a class="nav-link" onclick="UI.navTo('/profile');">My Orders</a>
            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
            <a class="nav-link text-primary" onclick="UI.navTo('/seller-dashboard');">Seller Dashboard</a>
            <a class="nav-link" onclick="UI.navTo('/seller-onboard');">Start Selling</a>
            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
            <a class="nav-link" onclick="UI.toggleAdmin()">ðŸ”’ Admin Panel</a>
        </div>
    </div>

    <main id="app" style="padding-top: var(--header-height);">
        </main>

    <div id="toast">Notification</div>

    <div id="dev-fab" onclick="UI.toggleDevTools()">ðŸ› </div>
    <div id="dev-tools" class="dev-panel">
        <h4>Dev Tools</h4>
        <label class="flex align-center gap-2 mt-2">
            <input type="checkbox" id="chk-fast-delivery"> Fast Delivery Sim
        </label>
        <label class="flex align-center gap-2 mt-2">
            <input type="checkbox" id="chk-fail-payment"> Rand. Pay Fail
        </label>
        <button class="btn btn-sm btn-outline w-full mt-4" onclick="Store.resetDemo()">Reset Demo Data</button>
    </div>

    <script>
        /* =========================================
           CONSTANTS & CONFIG
           ========================================= */
        const CONFIG = {
            commissionRate: 0.10, // 10%
            currency: '$',
            animationSpeed: 300
        };

        // Simple PubSub for events
        const Events = {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) this.listeners[event].forEach(cb => cb(data));
            }
        };

        /* =========================================
           DATA STORE (LocalStorage Wrapper)
           ========================================= */
        const Store = {
            init() {
                if (!localStorage.getItem('marketplace_products')) {
                    this.seed();
                }
                this.cleanupCarts();
            },
            get(key) { return JSON.parse(localStorage.getItem(key) || '[]'); },
            set(key, val) { localStorage.setItem(key, JSON.stringify(val)); },
            
            // Seed Demo Data
            seed() {
                console.log("Seeding Demo Data...");
                
                // Generate placeholders (Colored blocks)
                const ph = (text, color) => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = 500;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = color; ctx.fillRect(0,0,400,500);
                    ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.beginPath(); ctx.arc(200,250,100,0,2*Math.PI); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 40px Arial'; ctx.textAlign='center'; ctx.fillText(text, 200, 250);
                    return canvas.toDataURL('image/jpeg', 0.5);
                };

                const sellers = [
                    { id: 's1', name: 'Urban Threads', verified: true, bio: 'Minimalist street style.', balance: 150 },
                    { id: 's2', name: 'Silk & Spice', verified: false, bio: 'Handmade traditional wear.', balance: 40 },
                    { id: 's3', name: 'Denim Lab', verified: true, bio: 'Vintage denim restoration.', balance: 300 },
                    { id: 's4', name: 'Cozy Knits', verified: true, bio: 'Winter essentials.', balance: 80 },
                    { id: 's5', name: 'Active Life', verified: false, bio: 'Gym and yoga wear.', balance: 10 }
                ];

                const products = [
                    { id: 'p1', sellerId: 's1', title: 'Essential White Tee', price: 25, category: 'Tops', img: ph('Tee', '#FF6F61'), sizes: ['S','M','L'], desc: '100% Organic Cotton. Relaxed fit.' },
                    { id: 'p2', sellerId: 's1', title: 'Cargo Pants', price: 65, category: 'Bottoms', img: ph('Cargo', '#2F3A4A'), sizes: ['30','32','34'], desc: 'Durable utility pants with 6 pockets.' },
                    { id: 'p3', sellerId: 's2', title: 'Silk Scarf', price: 40, category: 'Accessories', img: ph('Scarf', '#FFB85C'), sizes: ['One Size'], desc: 'Hand-dyed silk scarf.' },
                    { id: 'p4', sellerId: 's3', title: 'Vintage Jacket', price: 120, discount: 95, category: 'Jackets', img: ph('Jacket', '#6B7280'), sizes: ['L', 'XL'], desc: 'Authentic 90s denim jacket.' },
                    { id: 'p5', sellerId: 's4', title: 'Wool Beanie', price: 20, category: 'Accessories', img: ph('Beanie', '#16A34A'), sizes: ['One Size'], desc: 'Warm merino wool.' },
                    { id: 'p6', sellerId: 's5', title: 'Yoga Leggings', price: 45, category: 'Bottoms', img: ph('Yoga', '#DC2626'), sizes: ['XS','S','M'], desc: 'High waist, squat proof.' },
                    { id: 'p7', sellerId: 's1', title: 'Linen Shirt', price: 50, category: 'Tops', img: ph('Shirt', '#8B5CF6'), sizes: ['M','L'], desc: 'Breathable summer wear.' },
                    { id: 'p8', sellerId: 's2', title: 'Floral Maxi Dress', price: 85, category: 'Dresses', img: ph('Dress', '#EC4899'), sizes: ['S','M'], desc: 'Perfect for brunch.' },
                    { id: 'p9', sellerId: 's3', title: 'Ripped Jeans', price: 70, category: 'Bottoms', img: ph('Jeans', '#3B82F6'), sizes: ['32','34'], desc: 'Slim fit with distressing.' },
                    { id: 'p10', sellerId: 's4', title: 'Chunky Sweater', price: 60, category: 'Tops', img: ph('Sweater', '#F59E0B'), sizes: ['M','L','XL'], desc: 'Oversized comfort.' },
                    { id: 'p11', sellerId: 's5', title: 'Gym Hoodie', price: 55, category: 'Tops', img: ph('Hoodie', '#10B981'), sizes: ['L','XL'], desc: 'Moisture wicking fabric.' },
                    { id: 'p12', sellerId: 's1', title: 'Canvas Totebag', price: 15, category: 'Accessories', img: ph('Bag', '#6366F1'), sizes: ['One Size'], desc: 'Eco-friendly shopping bag.' }
                ];

                this.set('marketplace_sellers', sellers);
                this.set('marketplace_products', products);
                this.set('marketplace_cart', []);
                this.set('marketplace_orders', []);
                this.set('marketplace_settings', { commission: 10 });
            },
            
            resetDemo() {
                localStorage.clear();
                location.reload();
            },

            cleanupCarts() {
                // Optional: remove old items if needed
            }
        };

        /* =========================================
           SERVICES (Mock Backend)
           ========================================= */
        const ImageService = {
            compress(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            // Max size 800px
                            const scale = Math.min(800 / Math.max(img.width, img.height), 1);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6)); // 60% quality
                        };
                    };
                    reader.onerror = reject;
                });
            }
        };

        const Cart = {
            getItems() { return Store.get('marketplace_cart'); },
            add(product, size) {
                const cart = this.getItems();
                const existing = cart.find(i => i.id === product.id && i.size === size);
                if (existing) existing.qty++;
                else cart.push({ ...product, size, qty: 1 });
                Store.set('marketplace_cart', cart);
                UI.updateCartBadge();
                UI.toast('Added to cart');
            },
            remove(idx) {
                const cart = this.getItems();
                cart.splice(idx, 1);
                Store.set('marketplace_cart', cart);
                UI.updateCartBadge();
                Router.refresh(); // Lazy reload
            },
            clear() { Store.set('marketplace_cart', []); UI.updateCartBadge(); },
            total() { return this.getItems().reduce((sum, i) => sum + ( (i.discount || i.price) * i.qty), 0); }
        };

        /* =========================================
           ROUTER & UI RENDERER
           ========================================= */
        const UI = {
            app: document.getElementById('app'),
            
            toggleMenu() {
                const menu = document.getElementById('nav-menu');
                const overlay = document.getElementById('nav-overlay');
                const isOpen = menu.classList.contains('open');
                if (isOpen) {
                    menu.classList.remove('open');
                    setTimeout(() => overlay.style.display = 'none', 300);
                } else {
                    overlay.style.display = 'block';
                    setTimeout(() => menu.classList.add('open'), 10);
                }
            },
            
            navTo(path) {
                this.toggleMenu();
                Router.go(path);
            },

            toggleAdmin() {
                const pw = prompt("Enter Admin Password (demo: admin)");
                if (pw === 'admin') {
                    this.toggleMenu();
                    Router.go('/admin');
                } else {
                    alert("Incorrect password");
                }
            },

            toggleDevTools() {
                const p = document.getElementById('dev-tools');
                p.style.display = p.style.display === 'block' ? 'none' : 'block';
            },

            toast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            },

            updateCartBadge() {
                const count = Store.get('marketplace_cart').reduce((s, i) => s + i.qty, 0);
                const b = document.getElementById('cart-count');
                b.textContent = count;
                b.classList.toggle('hidden', count === 0);
            },

            // --- RENDER HELPERS ---
            renderHeader(title) { return `<div class="container mt-4 mb-4"><h1>${title}</h1></div>`; },
            
            formatPrice(p, d) {
                if (d) return `<span class="text-primary">${CONFIG.currency}${d}</span> <small class="discount">${CONFIG.currency}${p}</small>`;
                return `${CONFIG.currency}${p}`;
            }
        };

        const Router = {
            routes: {
                '/': Views_Home,
                '/product': Views_Product,
                '/cart': Views_Cart,
                '/checkout': Views_Checkout,
                '/seller-onboard': Views_SellerOnboard,
                '/seller-dashboard': Views_SellerDashboard,
                '/admin': Views_Admin,
                '/profile': Views_Profile
            },
            
            init() {
                window.addEventListener('hashchange', () => this.resolve());
                this.resolve();
                UI.updateCartBadge();
            },
            
            go(path) { window.location.hash = path; },
            refresh() { this.resolve(); },
            
            resolve() {
                const hash = window.location.hash.slice(1) || '/';
                const [path, param] = hash.split(':');
                
                window.scrollTo(0,0);
                const renderer = this.routes[path] || Views_Home;
                UI.app.innerHTML = renderer(param);
                
                // Post-render hooks (listeners)
                if (path === '/checkout') Checkout.init();
                if (path === '/') Home.init();
                if (path === '/seller-dashboard') Seller.init();
            }
        };

        /* =========================================
           VIEWS (Component Functions)
           ========================================= */
        
        // --- HOME ---
        function Views_Home() {
            const products = Store.get('marketplace_products');
            const sellers = Store.get('marketplace_sellers');
            
            const categories = [...new Set(products.map(p => p.category))];
            
            let html = `
            <div class="container animate-in">
                <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; padding: 24px;">
                    <h2>Fresh Local Fashion</h2>
                    <p class="mt-2">Discover unique styles from sellers near you.</p>
                </div>
                
                <h3 class="mt-4 mb-4">Shop by Category</h3>
                <div class="chip-scroll">
                    <button class="chip active" onclick="Home.filter('all', this)">All</button>
                    ${categories.map(c => `<button class="chip" onclick="Home.filter('${c}', this)">${c}</button>`).join('')}
                </div>

                <h3 class="mt-4 mb-4">New Arrivals</h3>
                <div class="product-grid" id="home-grid">
                    ${products.map(p => {
                        const s = sellers.find(sl => sl.id === p.sellerId) || {};
                        return `
                        <div class="product-card" onclick="Router.go('/product:${p.id}')">
                            <img src="${p.img}" class="product-img" loading="lazy" alt="${p.title}">
                            <div class="product-info">
                                <div class="product-title">${p.title}</div>
                                <div class="product-seller">
                                    ${s.name} ${s.verified ? '<span class="verified-badge">âœ”</span>' : ''}
                                </div>
                                <div class="product-price">${UI.formatPrice(p.price, p.discount)}</div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
            return html;
        }

        const Home = {
            init() {},
            filter(cat, btn) {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                
                const products = Store.get('marketplace_products');
                const sellers = Store.get('marketplace_sellers');
                const filtered = cat === 'all' ? products : products.filter(p => p.category === cat);
                
                const grid = document.getElementById('home-grid');
                grid.innerHTML = filtered.map(p => {
                    const s = sellers.find(sl => sl.id === p.sellerId) || {};
                    return `
                        <div class="product-card" onclick="Router.go('/product:${p.id}')">
                            <img src="${p.img}" class="product-img" loading="lazy">
                            <div class="product-info">
                                <div class="product-title">${p.title}</div>
                                <div class="product-seller">${s.name} ${s.verified ? '<span class="verified-badge">âœ”</span>' : ''}</div>
                                <div class="product-price">${UI.formatPrice(p.price, p.discount)}</div>
                            </div>
                        </div>`;
                }).join('');
            }
        };

        // --- PRODUCT DETAIL ---
        function Views_Product(id) {
            const p = Store.get('marketplace_products').find(x => x.id === id);
            if (!p) return '<div class="container mt-4">Product not found.</div>';
            const s = Store.get('marketplace_sellers').find(x => x.id === p.sellerId);
            
            return `
            <div class="animate-in">
                <img src="${p.img}" style="width:100%; height:400px; object-fit:cover;">
                <div class="container" style="position:relative; top:-20px; background:var(--bg); border-radius: 24px 24px 0 0; padding-top:24px;">
                    <div class="flex justify-between align-center">
                        <div>
                            <h1 style="font-size:1.5rem;">${p.title}</h1>
                            <div class="product-seller mt-2" style="font-size:1rem;">
                                Sold by <strong>${s.name}</strong> ${s.verified ? 'âœ”' : ''}
                            </div>
                        </div>
                        <div style="text-align:right;">
                             <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">
                                ${p.discount ? CONFIG.currency + p.discount : CONFIG.currency + p.price}
                             </div>
                             ${p.discount ? `<small style="text-decoration:line-through;">${CONFIG.currency}${p.price}</small>` : ''}
                        </div>
                    </div>

                    <hr class="mt-4 mb-4" style="border:0; border-top:1px solid #e5e7eb;">

                    <label class="form-label">Select Size</label>
                    <div class="flex gap-2 mb-4">
                        ${p.sizes.map(sz => `<button class="btn btn-outline btn-sm" onclick="this.classList.toggle('btn-primary'); this.classList.toggle('btn-outline'); window.selectedSize='${sz}'">${sz}</button>`).join('')}
                    </div>

                    <h3 class="mb-2">Description</h3>
                    <p class="text-light" style="line-height:1.6;">${p.desc}</p>

                    <div style="height:80px;"></div>
                </div>

                <div style="position:fixed; bottom:0; width:100%; background:white; padding:16px; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); display:flex; gap:16px;">
                    <button class="btn btn-outline" onclick="alert('Chat feature coming soon!')">Chat</button>
                    <button class="btn btn-primary w-full" onclick="Product.addToCart('${p.id}')">Add to Cart</button>
                </div>
            </div>`;
        }

        const Product = {
            addToCart(id) {
                if (!window.selectedSize) return alert("Please select a size.");
                const p = Store.get('marketplace_products').find(x => x.id === id);
                Cart.add(p, window.selectedSize);
            }
        };

        // --- CART ---
        function Views_Cart() {
            const items = Cart.getItems();
            if (items.length === 0) return `<div class="container mt-4 text-center"><h2 class="mb-4">Your Cart is Empty</h2><button class="btn btn-primary" onclick="Router.go('/')">Go Shopping</button></div>`;
            
            return `
            <div class="container mt-4 animate-in">
                <h1>My Cart</h1>
                <div class="mt-4">
                    ${items.map((item, idx) => `
                    <div class="card flex gap-4 align-center" style="position:relative;">
                        <img src="${item.img}" style="width:60px; height:60px; border-radius:8px; object-fit:cover;">
                        <div style="flex:1;">
                            <div class="font-bold">${item.title}</div>
                            <small>Size: ${item.size} | Qty: ${item.qty}</small>
                            <div class="text-primary font-bold">${CONFIG.currency}${ (item.discount||item.price) * item.qty }</div>
                        </div>
                        <button class="btn btn-outline btn-circle text-danger" onclick="Cart.remove(${idx})" style="font-size:1.2rem;">&times;</button>
                    </div>
                    `).join('')}
                </div>
                
                <div class="card mt-4">
                    <div class="flex justify-between font-bold" style="font-size:1.2rem;">
                        <span>Total</span>
                        <span>${CONFIG.currency}${Cart.total()}</span>
                    </div>
                    <button class="btn btn-primary w-full mt-4" onclick="Router.go('/checkout')">Proceed to Checkout</button>
                </div>
            </div>`;
        }

        // --- CHECKOUT ---
        function Views_Checkout() {
            const total = Cart.total();
            return `
            <div class="container mt-4 animate-in pb-5">
                <h2 class="mb-4">Checkout</h2>
                
                <form id="checkout-form" onsubmit="event.preventDefault(); Checkout.process();">
                    <div class="card">
                        <h3 class="mb-2">Shipping Address</h3>
                        <div class="form-group">
                            <input class="form-input" placeholder="Full Name" required value="John Doe">
                        </div>
                        <div class="form-group">
                            <input class="form-input" placeholder="Address Line 1" required value="123 Main St">
                        </div>
                         <div class="form-group">
                            <input class="form-input" placeholder="City, State" required value="Colombo">
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="mb-2">Payment Method</h3>
                        <label class="card flex align-center gap-4" style="cursor:pointer; border:1px solid var(--primary);">
                            <input type="radio" name="pay" value="card" checked> 
                            <span>Credit/Debit Card</span>
                        </label>
                        <label class="card flex align-center gap-4" style="cursor:pointer;">
                            <input type="radio" name="pay" value="mobile"> 
                            <span>Mobile Pay / Cash on Delivery</span>
                        </label>
                    </div>

                    <div class="card">
                        <h3 class="mb-2">Summary</h3>
                        <div class="flex justify-between mb-2"><span>Subtotal</span><span>${CONFIG.currency}${total}</span></div>
                        <div class="flex justify-between mb-2"><span>Shipping</span><span>${CONFIG.currency}5.00</span></div>
                        <hr>
                        <div class="flex justify-between font-bold mt-2" style="font-size:1.2rem;">
                            <span>Total</span><span>${CONFIG.currency}${total + 5}</span>
                        </div>
                    </div>

                    <button type="submit" id="pay-btn" class="btn btn-primary w-full" style="position:fixed; bottom:16px; left:16px; right:16px; width:calc(100% - 32px); box-shadow:0 4px 20px rgba(0,0,0,0.2);">
                        Confirm Purchase (${CONFIG.currency}${total + 5})
                    </button>
                </form>
            </div>`;
        }

        const Checkout = {
            init() {},
            process() {
                const btn = document.getElementById('pay-btn');
                btn.disabled = true; btn.innerText = "Processing...";

                // Simulation
                setTimeout(() => {
                    const shouldFail = document.getElementById('chk-fail-payment').checked && Math.random() > 0.5;
                    
                    if (shouldFail) {
                        alert("Payment Failed. Please try again.");
                        btn.disabled = false; btn.innerText = "Confirm Purchase";
                    } else {
                        // Create Order
                        const items = Cart.getItems();
                        const order = {
                            id: 'ORD-' + Date.now(),
                            date: new Date().toISOString(),
                            items: items,
                            total: Cart.total() + 5,
                            status: 'Pending', // Pending -> Accepted -> Shipped -> Delivered
                            buyer: 'John Doe'
                        };
                        
                        // Save Order Global
                        const orders = Store.get('marketplace_orders');
                        orders.unshift(order);
                        Store.set('marketplace_orders', orders);
                        
                        // Empty Cart
                        Cart.clear();
                        
                        // Show Success
                        UI.app.innerHTML = `
                        <div class="container mt-4 text-center animate-in">
                            <div style="font-size:4rem; color:var(--success);">âœ”</div>
                            <h2>Order Placed!</h2>
                            <p>Order ID: ${order.id}</p>
                            <button class="btn btn-primary mt-4" onclick="Router.go('/profile')">Track Order</button>
                        </div>`;
                        
                        // Simulate Seller Acceptance (Optional Dev Tool)
                        if (document.getElementById('chk-fast-delivery').checked) {
                           setTimeout(() => {
                               order.status = "Delivered";
                               // update order in storage logic omitted for brevity of this block, but would be needed
                           }, 2000);
                        }
                    }
                }, 1500);
            }
        };

        // --- SELLER DASHBOARD ---
        function Views_SellerDashboard() {
            // Simple simulation: current user is Seller ID 's1'
            const sellerId = 's1'; 
            const seller = Store.get('marketplace_sellers').find(s => s.id === sellerId);
            if(!seller) return `<div class="container mt-4">Error: Seller not found. <button onclick="Router.go('/seller-onboard')">Create Shop</button></div>`;

            const products = Store.get('marketplace_products').filter(p => p.sellerId === sellerId);
            const allOrders = Store.get('marketplace_orders');
            // Filter orders that contain items from this seller
            const myOrders = allOrders.filter(o => o.items.some(i => i.sellerId === sellerId));

            return `
            <div class="container mt-4 animate-in">
                <div class="flex justify-between align-center mb-4">
                    <h2>${seller.name}</h2>
                    ${seller.verified ? '<span class="badge" style="position:static; padding:4px 8px;">Verified</span>' : ''}
                </div>
                
                <div class="flex gap-2 mb-4" style="display:grid; grid-template-columns: 1fr 1fr;">
                    <div class="stat-card">
                        <div class="stat-val">${CONFIG.currency}${seller.balance}</div>
                        <div class="stat-label">Earnings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val">${myOrders.length}</div>
                        <div class="stat-label">Orders</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Quick Actions</h3>
                    <div class="flex gap-2 mt-2">
                        <button class="btn btn-primary btn-sm w-full" onclick="document.getElementById('add-prod-modal').classList.remove('hidden')">+ Add Product</button>
                        <button class="btn btn-outline btn-sm w-full" onclick="alert('Payout requested!')">Request Payout</button>
                    </div>
                </div>

                <h3>Recent Orders</h3>
                <div class="mt-2">
                    ${myOrders.length === 0 ? '<p class="text-light">No orders yet.</p>' : 
                      myOrders.map(o => `
                        <div class="card">
                            <div class="flex justify-between">
                                <strong>${o.id}</strong>
                                <span class="text-primary">${o.status}</span>
                            </div>
                            <small>${new Date(o.date).toLocaleDateString()}</small>
                            <div class="mt-2">
                                ${o.items.filter(i => i.sellerId === sellerId).map(i => `<div>${i.qty}x ${i.title}</div>`).join('')}
                            </div>
                            ${o.status === 'Pending' ? `<button class="btn btn-sm btn-secondary mt-2 w-full" onclick="Seller.updateStatus('${o.id}', 'Shipped')">Mark Shipped</button>` : ''}
                        </div>
                      `).join('')
                    }
                </div>

                <h3>My Products</h3>
                <div class="mt-2 mb-4">
                     ${products.map(p => `
                        <div class="card flex gap-2 align-center p-2">
                            <img src="${p.img}" style="width:50px; height:50px; border-radius:4px;">
                            <div style="flex:1;">${p.title}</div>
                            <div class="font-bold">${CONFIG.currency}${p.price}</div>
                        </div>
                     `).join('')}
                </div>
            </div>

            <div id="add-prod-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:500; padding:20px; overflow-y:auto;">
                <div class="card animate-in">
                    <h2>Add Product</h2>
                    <form onsubmit="event.preventDefault(); Seller.addProduct(this);">
                        <div class="form-group mt-2"><input class="form-input" name="title" placeholder="Title" required></div>
                        <div class="form-group"><input class="form-input" name="price" type="number" placeholder="Price" required></div>
                        <div class="form-group">
                            <select class="form-select" name="category">
                                <option>Tops</option><option>Bottoms</option><option>Dresses</option><option>Accessories</option>
                            </select>
                        </div>
                        <div class="form-group"><textarea class="form-textarea" name="desc" placeholder="Description" rows="3"></textarea></div>
                        <div class="form-group">
                            <label class="form-label">Image</label>
                            <input type="file" accept="image/*" id="prod-img-input" required>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="btn btn-outline w-full" onclick="document.getElementById('add-prod-modal').classList.add('hidden')">Cancel</button>
                            <button type="submit" class="btn btn-primary w-full">Save</button>
                        </div>
                    </form>
                </div>
            </div>
            `;
        }

        const Seller = {
            init() {},
            async addProduct(form) {
                const file = document.getElementById('prod-img-input').files[0];
                if(!file) return alert("Image required");

                UI.toast("Compressing image...");
                try {
                    const base64 = await ImageService.compress(file);
                    const newProd = {
                        id: 'p-' + Date.now(),
                        sellerId: 's1', // Hardcoded for demo
                        title: form.title.value,
                        price: parseFloat(form.price.value),
                        category: form.category.value,
                        desc: form.desc.value,
                        sizes: ['S','M','L'], // simplified
                        img: base64
                    };
                    
                    const prods = Store.get('marketplace_products');
                    prods.unshift(newProd);
                    Store.set('marketplace_products', prods);
                    
                    document.getElementById('add-prod-modal').classList.add('hidden');
                    UI.toast("Product Added!");
                    Router.refresh();
                } catch(e) {
                    alert("Error uploading image");
                }
            },
            updateStatus(oid, status) {
                const orders = Store.get('marketplace_orders');
                const order = orders.find(o => o.id === oid);
                if(order) {
                    order.status = status;
                    Store.set('marketplace_orders', orders);
                    Router.refresh();
                    UI.toast(`Order marked as ${status}`);
                }
            }
        };

        // --- SELLER ONBOARDING ---
        function Views_SellerOnboard() {
            return `
            <div class="container mt-4 animate-in">
                <h1>Start Selling</h1>
                <p class="mb-4 text-light">Join thousands of local sellers.</p>
                <form class="card" onsubmit="event.preventDefault(); alert('Shop Created (Demo)! Redirecting...'); Router.go('/seller-dashboard');">
                    <div class="form-group">
                        <label class="form-label">Shop Name</label>
                        <input class="form-input" required placeholder="e.g. Vintage Vibes">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ID Proof (KYC)</label>
                        <input type="file" class="form-input">
                    </div>
                    <button class="btn btn-primary w-full">Create Shop</button>
                </form>
            </div>`;
        }

        // --- ADMIN ---
        function Views_Admin() {
            const sellers = Store.get('marketplace_sellers');
            const orders = Store.get('marketplace_orders');
            const settings = Store.get('marketplace_settings');

            return `
            <div class="container mt-4 animate-in">
                <h1>Admin Panel</h1>
                
                <div class="card mt-4">
                    <h3>Settings</h3>
                    <div class="flex justify-between align-center mt-2">
                        <span>Commission Rate (%)</span>
                        <input type="number" value="${settings.commission}" style="width:60px; padding:4px;" onchange="Store.set('marketplace_settings', {...settings, commission: this.value}); UI.toast('Saved');">
                    </div>
                </div>

                <h3>Sellers (${sellers.length})</h3>
                <div class="mt-2">
                    ${sellers.map(s => `
                        <div class="card flex justify-between align-center p-2">
                            <div>
                                <strong>${s.name}</strong>
                                <div style="font-size:0.8rem;">Bal: ${CONFIG.currency}${s.balance}</div>
                            </div>
                            ${!s.verified ? `<button class="btn btn-sm btn-success" onclick="Admin.verify('${s.id}')">Verify</button>` : '<span class="text-success">Verified</span>'}
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        const Admin = {
            verify(sid) {
                const sellers = Store.get('marketplace_sellers');
                const s = sellers.find(x => x.id === sid);
                if(s) { s.verified = true; Store.set('marketplace_sellers', sellers); Router.refresh(); }
            }
        };

        // --- USER PROFILE (Orders) ---
        function Views_Profile() {
            const orders = Store.get('marketplace_orders'); // In real app, filter by user ID
            
            return `
            <div class="container mt-4 animate-in">
                <h1>My Orders</h1>
                <div class="mt-4">
                    ${orders.length === 0 ? 'No orders yet.' : orders.map(o => `
                        <div class="card">
                            <div class="flex justify-between font-bold">
                                <span>${o.id}</span>
                                <span class="${o.status === 'Delivered' ? 'text-success' : 'text-primary'}">${o.status}</span>
                            </div>
                            <div class="mt-2 text-light">Total: ${CONFIG.currency}${o.total}</div>
                            ${o.status === 'Shipped' ? `<button class="btn btn-sm btn-primary w-full mt-2" onclick="Seller.updateStatus('${o.id}', 'Delivered')">Confirm Receipt</button>` : ''}
                            ${o.status === 'Delivered' ? `<div class="mt-2 text-center text-success">Thanks for shopping!</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        /* =========================================
           BOOTSTRAP
           ========================================= */
        Store.init();
        Router.init();

    </script>
</body>
</html>